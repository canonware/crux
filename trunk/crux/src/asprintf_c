/* -*- mode: c ; c-file-style: "canonware-c-style" -*-
 ******************************************************************************
 *
 * <Copyright = jasone>
 * <License>
 *
 ******************************************************************************
 *
 * Version: Crux <Version = crux>
 *
 * Emulate vasprintf() and asprintf().
 *
 ******************************************************************************/

#include <stdio.h>
#include <stdarg.h>

int
vasprintf(char **rResult, const char *aFormat, va_list aAp)
{
    int rVal;
    char *result;
    va_list ap;
#define CxmAsprintfStartLen 16

    result = (char *) malloc(CxmAsprintfStartLen);
    if (result == NULL)
    {
	rVal = -1;
	goto RETURN;
    }

    va_copy(ap, aAp);
    rVal = vsnprintf(result, CxmAsprintfStartLen, aFormat, ap);
    va_end(ap);

    if (rVal == -1)
    {
	goto RETURN;
    }
    else if (rVal >= CxmAsprintfStartLen)
    {
	free(result);
	result = (char *) malloc(rVal + 1);
	if (result == NULL)
	{
	    rVal = -1;
	    goto RETURN;
	}

	va_copy(ap, aAp);
	rVal = vsnprintf(result, rVal + 1, aFormat, aAp);
	va_end(ap);
    }

    *rResult = result;
    RETURN:
#undef CxmAsprintfStartLen
    return rVal;
}

static int
asprintf(char **rResult, const char *aFormat, ...)
{
    int rVal;
    va_list ap;

    va_start(ap, aFormat);
    rVal = vasprintf(rResult, aFormat, ap);
    va_end(ap);

    return rVal;
}
