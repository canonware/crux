################################################################################
#
# Version: Crux <Version = crux>
#
# Makefile.in
#
################################################################################

SHELL := /bin/sh

# Force a full rebuild if any of the header files have changed.  In an ideal
# world, all build dependencies would be tracked in one place, but setup.py
# only does part of the job, so this kludge is necessary to avoid inconsistent
# partial rebuilds.
all:
	@sh -c 'force=0; \
		for f in @crux_headers@; do \
			if test "@objroot@/build.stamp" -ot "$$f"; then \
				echo Force full rebuild due to $$f; \
				force=1; \
			fi \
		done; \
		if test "x$$force" = "x0"; then \
			echo "@PYTHON@ setup.py build"; \
			@PYTHON@ setup.py build; \
		else \
			echo "@PYTHON@ setup.py build --force"; \
			@PYTHON@ setup.py build --force; \
		fi'
	echo stamp > @objroot@/build.stamp

install:
	@PYTHON@ setup.py install

check: all
	@sh -c 'total=0; \
		failures=0; \
		echo "========================================="; \
		for t in @crux_tests@; do \
			total=`expr $$total + 1`; \
			echo -n "$$t ... "; \
			@objroot@/crux --batch --quiet --infile=$$t \
			  -- @srcroot@ @objroot@ \
			  > $${t}.out 2>/dev/null; \
			if test -e "$${t}.exp"; then \
				diff -u $${t}.exp $${t}.out; \
				fail=$$?; \
				if test "$$fail" -eq "1" ; then \
					failures=`expr $$failures + 1`; \
					echo "*** FAIL ***"; \
				else \
					echo "pass"; \
				fi; \
			else \
				echo "*** FAIL *** (.exp file is missing)"; \
				failures=`expr $$failures + 1`; \
			fi; \
		done; \
		echo "========================================="; \
		echo "Failures: $$failures/$$total"'

clean:
	rm -rf @objroot@/build
	@sh -c 'for t in @crux_tests@; do \
			echo "rm -f $${t}.out"; \
			rm -f $${t}.out; \
		done'

distclean: clean
	rm -f @objroot@/config.log
	rm -f @objroot@/config.status
	rm -f @objroot@/config.stamp
	rm -f @cfghdrs@
	rm -f @cfgoutputs@

relclean: distclean
	rm -f @objroot@/aclocal.m4
	rm -rf @objroot@/autom4te.cache
	rm -f @objroot@/configure

# Re-configuration rules.
ifeq (@enable_autogen@, 1)
@srcroot@/aclocal.m4 : @srcroot@/acinclude.m4
	cd @srcroot@ && @ACLOCAL@

@srcroot@/configure : @srcroot@/configure.in @srcroot@/aclocal.m4
	cd @srcroot@ && @AUTOCONF@

@objroot@/config.status : @srcroot@/configure
	@objroot@/config.status --recheck

@srcroot@/config.stamp.in : @srcroot@/configure.in @srcroot@/aclocal.m4
	cd @srcroot@ && @AUTOHEADER@
	echo stamp > @srcroot@/config.stamp.in

$(patsubst %, @srcroot@/%.in, @cfghdrs@) : @srcroot@/config.stamp.in

@objroot@/config.stamp : $(patsubst %, @srcroot@/%.in, @cfghdrs@) \
			 @objroot@/config.status
	@objroot@/config.status

$(patsubst %, @objroot@/%, @cfgoutputs@) : \
		$(patsubst %, @srcroot@/%.in, @cfgoutputs@) \
		@objroot@/config.status
	@objroot@/config.status
endif
