#!@PYTHON@@python_opts@
################################################################################
#
# <Copyright = jasone>
# <License>
#
################################################################################
#
# Version: Crux <Version = crux>
#
################################################################################

from glob import glob
import re

from distutils.core import setup, Extension
if @enable_cython@:
    from Cython.Distutils import build_ext

libraries = []
ext_modules = []

if @enable_cython@:
    cy_suffix = "pyx"
    cmdclass = {'build_ext': build_ext}
else:
    cy_suffix = "c"
    cmdclass = {}

if @enable_debug@:
    extra_compile_args = []
else:
    extra_compile_args = ['-DPYREX_WITHOUT_ASSERTIONS']

# libCx
sources = glob("@srcroot@/src/Crux/Cx*.c")
library = ("Cx", {
  "sources": sources,
  "include_dirs": ["@srcroot@/src/Crux", "@objroot@/src/Crux"],
  "extra_compile_args": (extra_compile_args + [@extra_compile_args@])
})
libraries.append(library)

# Crux.*
# Always glob .pyx files in order to exclude the Cx*.c files, but if directly
# using Cython-generated .c files, convert the file suffix to .c inside the
# loop.
for path in glob("@srcroot@/src/Crux/[A-Z_]*.pyx"):
    if cy_suffix == "c":
        path = re.sub(r"\.pyx$", r"\.c", path)
    subpath = re.match(r"@srcroot@/src/(.*)", path).group(1)
    fsplit = re.split(r"[/.]", subpath)
    module = ".".join(fsplit[:-1])
    ext = Extension(
      ".".join(fsplit[:-1]),
      sources=[path],
      include_dirs=["@srcroot@/src", "@srcroot@/src/Crux"],
      extra_compile_args=extra_compile_args,
      )
    ext_modules.append(ext)
# Parsing
ext = Extension(
  'Parsing',
  sources=["@srcroot@/src/Parsing.%s" % cy_suffix],
  extra_compile_args=extra_compile_args
  )
ext_modules.append(ext)

setup(
  name = 'Crux',
  version = '@crux_version@',
  description = 'Pylogenetic inference program',
  author = 'Jason Evans',
  author_email = 'jasone@canonware.com',
  url = 'http://www.canonware.com/cgi-bin/hg_crux',
  download_url = 'http://www.canonware.com/cgi-bin/hg_crux',
  package_dir = {'': '@srcroot@/src'},
  packages = ['Crux'],
  ext_modules = ext_modules,
  libraries = libraries,
  scripts = ['@objroot@/bin/crux'],
  cmdclass = cmdclass
  )
